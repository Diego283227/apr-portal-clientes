import React, { useState, useEffect, useCallback } from 'react';
import { X, ArrowRight, CheckCircle, Target } from 'lucide-react';

interface TutorialStep {
  id: string;
  target: string;
  title: string;
  description: string;
  action: string;
  position: 'top' | 'bottom' | 'left' | 'right';
}

interface TutorialStep {
  id: string;
  target: string;
  title: string;
  description: string;
  action: string;
  position: 'top' | 'bottom' | 'left' | 'right';
  explanationTitle?: string;
  explanationDescription?: string;
}

const TUTORIAL_STEPS: TutorialStep[] = [
  {
    id: 'welcome',
    target: 'body',
    title: '¬°Bienvenido al Portal APR!',
    description: 'Te voy a mostrar c√≥mo usar cada parte de la plataforma. Haz clic exactamente donde te indique y despu√©s te explico para qu√© sirve.',
    action: 'Haz clic en "Continuar" para empezar',
    position: 'top'
  },
  {
    id: 'profile',
    target: '#socio-profile',
    title: 'Haz clic en tu Perfil',
    description: 'Primero haz clic en tu perfil para acceder a √©l.',
    action: 'HAZ CLIC en tu perfil resaltado',
    position: 'right',
    explanationTitle: '‚úÖ Perfecto! Accediste a tu Perfil',
    explanationDescription: 'Excelente! Ahora est√°s viendo tu perfil personal. En los pr√≥ximos pasos te voy a mostrar cada elemento espec√≠fico de esta pantalla: los campos que puedes editar, tu saldo, tu deuda, y c√≥mo funciona el auto-guardado.'
  },
  // Profile sub-steps
  {
    id: 'profile-rut-section',
    target: 'div[id="rut-section"], #rut-section',
    title: 'Secci√≥n RUT',
    description: 'Te muestro la secci√≥n de tu RUT con funcionalidades especiales.',
    action: 'HAZ CLIC en la secci√≥n de tu RUT (campo gris con botones)',
    position: 'right',
    explanationTitle: '‚úÖ Secci√≥n RUT con Funcionalidades',
    explanationDescription: 'Esta secci√≥n tiene funciones especiales:\n\n‚Ä¢ Tu RUT est√° protegido (no se puede editar)\n‚Ä¢ üîä BOT√ìN DE AUDIO: Reproduce tu RUT en voz alta\n‚Ä¢ üëÅÔ∏è BOT√ìN VER PERFIL: Vuelve al inicio del perfil\n‚Ä¢ Conversi√≥n a palabras para accesibilidad\n‚Ä¢ Identificador √∫nico y seguro\n\nEsto es √∫til para personas con dificultades visuales.'
  },
  {
    id: 'profile-edit-button',
    target: 'button[id="edit-profile-btn"], #edit-profile-btn',
    title: 'Bot√≥n Editar Perfil',
    description: 'Este bot√≥n es clave para editar tu informaci√≥n.',
    action: 'HAZ CLIC en el bot√≥n "Editar (Auto-guardado)"',
    position: 'left',
    explanationTitle: '‚úÖ Bot√≥n de Edici√≥n con Auto-guardado',
    explanationDescription: 'FUNCIONALIDAD PRINCIPAL:\n\n‚Ä¢ Activa el modo de edici√≥n\n‚Ä¢ Una vez activo, CUALQUIER cambio se guarda autom√°ticamente\n‚Ä¢ NO necesitas hacer clic en "Guardar"\n‚Ä¢ Auto-guardado cada 500ms\n‚Ä¢ Aparecer√° indicador "Guardando..." cuando trabaje\n‚Ä¢ Se desactiva autom√°ticamente despu√©s de guardar\n\n¬°Es completamente autom√°tico!'
  },
  {
    id: 'profile-phone-section', 
    target: 'div[id="telefono-field"], #telefono-field',
    title: 'Campo Tel√©fono',
    description: 'Campo editable m√°s importante de tu perfil.',
    action: 'HAZ CLIC en la secci√≥n del tel√©fono',
    position: 'right',
    explanationTitle: '‚úÖ Tel√©fono con Auto-guardado',
    explanationDescription: 'CAMPO EDITABLE:\n\n‚Ä¢ Cuando hagas clic en "Editar", este campo se activar√°\n‚Ä¢ Puedes escribir directamente tu nuevo n√∫mero\n‚Ä¢ Se guarda autom√°ticamente cada 500ms\n‚Ä¢ No necesitas bot√≥n "Guardar"\n‚Ä¢ Acepta formato internacional (+56 9 1234 5678)\n‚Ä¢ Esencial para recibir notificaciones'
  },
  {
    id: 'profile-address-section',
    target: 'div[id="direccion-field"], #direccion-field',
    title: 'Campo Direcci√≥n',
    description: 'Otro campo que puedes editar libremente.',
    action: 'HAZ CLIC en la secci√≥n de direcci√≥n',
    position: 'right',
    explanationTitle: '‚úÖ Direcci√≥n Editable',
    explanationDescription: 'CAMPO DE TEXTO LIBRE:\n\n‚Ä¢ Tambi√©n se activa con el bot√≥n "Editar"\n‚Ä¢ Puedes escribir tu direcci√≥n completa\n‚Ä¢ Auto-guardado cada 500ms como el tel√©fono\n‚Ä¢ Acepta m√∫ltiples l√≠neas\n‚Ä¢ Importante para facturaci√≥n y entregas\n‚Ä¢ Mant√©n tu direcci√≥n actualizada'
  },
  {
    id: 'profile-financial-section',
    target: '.bg-green-50.rounded-lg.border-l-4.border-green-500, .bg-green-50:has(.text-green-700)',
    title: 'Estado Financiero',
    description: 'Informaci√≥n de tu saldo y deudas.',
    action: 'HAZ CLIC en la secci√≥n financiera (verde)',
    position: 'left',
    explanationTitle: '‚úÖ Informaci√≥n Financiera',
    explanationDescription: 'DATOS FINANCIEROS IMPORTANTES:\n\n‚Ä¢ SALDO ACTUAL: Dinero disponible en tu cuenta\n‚Ä¢ DEUDA TOTAL: Lo que debes actualmente\n‚Ä¢ Colores indicativos:\n  - Verde: Al d√≠a o saldo positivo\n  - Amarillo: Deuda moderada\n  - Rojo: Deuda cr√≠tica\n‚Ä¢ Se actualiza autom√°ticamente con pagos\n‚Ä¢ Solo lectura, no editable'
  },
  {
    id: 'boletas',
    target: '#nav-boletas',
    title: 'Haz clic en Mis Boletas',
    description: 'Ahora vamos a ver tus facturas de agua.',
    action: 'HAZ CLIC en "Mis Boletas" resaltado',
    position: 'right',
    explanationTitle: '‚úÖ Excelente! Accediste a tus Boletas',
    explanationDescription: 'Ahora vamos a explorar las funcionalidades de esta secci√≥n.'
  },
  // Boletas sub-steps
  {
    id: 'boletas-summary-cards',
    target: '.grid.grid-cols-1.md\\:grid-cols-4.gap-6.mb-8, div:has(.text-sm.font-medium.text-gray-600:contains("Total Boletas"))',
    title: 'Resumen de Boletas',
    description: 'Te muestro las tarjetas de resumen con estad√≠sticas importantes.',
    action: 'HAZ CLIC en las tarjetas de resumen',
    position: 'top',
    explanationTitle: '‚úÖ Tarjetas de Resumen',
    explanationDescription: 'Estas 4 tarjetas muestran informaci√≥n clave:\n\n‚Ä¢ TOTAL BOLETAS: Cantidad total de facturas\n‚Ä¢ PENDIENTES: Boletas por pagar (amarillo) ‚è≥\n‚Ä¢ VENCIDAS: Boletas atrasadas (rojo) ‚ö†Ô∏è\n‚Ä¢ DEUDA TOTAL: Monto total que debes\n\n‚Ä¢ Se actualizan autom√°ticamente\n‚Ä¢ Colores indican urgencia\n‚Ä¢ Informaci√≥n en tiempo real'
  },
  {
    id: 'boletas-search-section',
    target: 'input[placeholder*="Buscar por n√∫mero de boleta"], .relative:has(.Search)',
    title: 'Buscador de Boletas',
    description: 'Campo de b√∫squeda inteligente para encontrar boletas espec√≠ficas.',
    action: 'HAZ CLIC en el campo de b√∫squeda',
    position: 'bottom',
    explanationTitle: '‚úÖ B√∫squeda Inteligente',
    explanationDescription: 'FUNCIONALIDAD DE B√öSQUEDA:\n\n‚Ä¢ Busca por N√öMERO DE BOLETA\n‚Ä¢ Busca por PER√çODO (mes/a√±o)\n‚Ä¢ üîç √çcono de lupa integrado\n‚Ä¢ B√∫squeda en tiempo real\n‚Ä¢ No distingue may√∫sculas/min√∫sculas\n‚Ä¢ Se combina con los filtros\n\nEjemplo: "enero 2024" o "BOL-001"'
  },
  {
    id: 'boletas-filter-section',
    target: '.flex.gap-2:has(button:contains("Todas")), div:has(button:contains("Pendientes"))',
    title: 'Filtros por Estado',
    description: 'Filtros para organizar boletas por su estado de pago.',
    action: 'HAZ CLIC en los filtros de estado',
    position: 'top',
    explanationTitle: '‚úÖ Sistema de Filtros',
    explanationDescription: 'FILTROS DISPONIBLES:\n\n‚Ä¢ TODAS: Muestra todas las boletas\n‚Ä¢ PENDIENTES ‚è≥: Solo las por pagar\n‚Ä¢ PAGADAS ‚úÖ: Solo las ya canceladas  \n‚Ä¢ VENCIDAS ‚ö†Ô∏è: Solo las atrasadas\n\n‚Ä¢ Se combina con la b√∫squeda\n‚Ä¢ Cambia autom√°ticamente las estad√≠sticas\n‚Ä¢ Facilita la organizaci√≥n'
  },
  {
    id: 'boletas-table-section',
    target: '.space-y-4:has(.hover\\:shadow-md), div:has(.font-semibold.text-lg:contains("Boleta"))',
    title: 'Lista de Boletas',
    description: 'Lista principal con todas tus boletas y sus detalles.',
    action: 'HAZ CLIC en la lista de boletas',
    position: 'right',
    explanationTitle: '‚úÖ Lista de Boletas Detallada',
    explanationDescription: 'INFORMACI√ìN EN CADA TARJETA:\n\n‚Ä¢ N√öMERO: Identificador √∫nico de la boleta\n‚Ä¢ PER√çODO: Mes/a√±o de la facturaci√≥n\n‚Ä¢ FECHA EMISI√ìN: Cu√°ndo se emiti√≥\n‚Ä¢ FECHA VENCIMIENTO: Hasta cu√°ndo pagar\n‚Ä¢ MONTO: Cantidad a pagar\n‚Ä¢ ESTADO: Badge de color seg√∫n estado\n‚Ä¢ ACCIONES: Botones para cada boleta'
  },
  {
    id: 'boletas-actions-section',
    target: '.flex.flex-col.sm\\:flex-row.gap-2:has(button), button:has(.Download)',
    title: 'Botones de Acci√≥n',
    description: 'Botones para interactuar con cada boleta individual.',
    action: 'HAZ CLIC en un bot√≥n de acci√≥n',
    position: 'left',
    explanationTitle: '‚úÖ Acciones por Boleta',
    explanationDescription: 'BOTONES DISPONIBLES:\n\n‚Ä¢ üìÑ VER DETALLE: Informaci√≥n completa de la boleta\n‚Ä¢ üìÑ DESCARGAR PDF: Guarda la boleta en tu dispositivo\n‚Ä¢ üí≥ PAGAR: Ir directamente al proceso de pago\n\n‚Ä¢ √çconos claros para cada funci√≥n\n‚Ä¢ Acceso r√°pido y directo\n‚Ä¢ Estados din√°micos seg√∫n boleta'
  },
  {
    id: 'pago',
    target: '#nav-pago',
    title: 'Haz clic en Realizar Pago',
    description: 'Veamos c√≥mo puedes pagar tus deudas.',
    action: 'HAZ CLIC en "Realizar Pago" resaltado',
    position: 'right',
    explanationTitle: '‚úÖ Perfecto! Accediste a Pagos',
    explanationDescription: 'Ahora vamos a ver c√≥mo funciona el sistema de pagos.'
  },
  // Pagos sub-steps
  {
    id: 'pago-bills-selection',
    target: '.lg\\:col-span-2 .space-y-6, div:has(#select-all)',
    title: 'Selecci√≥n de Boletas',
    description: 'Te muestro la secci√≥n donde seleccionas qu√© boletas pagar.',
    action: 'HAZ CLIC en la secci√≥n de selecci√≥n de boletas',
    position: 'right',
    explanationTitle: '‚úÖ Selecci√≥n Inteligente de Boletas',
    explanationDescription: 'Esta secci√≥n te permite:\n\n‚Ä¢ SELECCIONAR TODAS: Checkbox para pagar todas las pendientes\n‚Ä¢ SELECCI√ìN INDIVIDUAL: Elige boletas espec√≠ficas con checkbox\n‚Ä¢ INFORMACI√ìN COMPLETA: N√∫mero, per√≠odo, consumo, vencimiento\n‚Ä¢ ESTADO VISUAL: Badges rojas para vencidas, amarillas para pendientes\n‚Ä¢ CONTROL TOTAL: T√∫ decides qu√© pagar y cu√°ndo\n\n‚Ä¢ Optimiza tu flujo de caja\n‚Ä¢ Evita pagos innecesarios\n‚Ä¢ Gesti√≥n financiera inteligente'
  },
  {
    id: 'pago-methods-section',
    target: 'div:has([data-state]), .space-y-3:has(.RadioGroup), div:has(input[type="radio"])',
    title: 'M√©todos de Pago',
    description: 'Te muestro los m√©todos de pago seguros disponibles.',
    action: 'HAZ CLIC en la secci√≥n de m√©todos de pago',
    position: 'left',
    explanationTitle: '‚úÖ M√©todos de Pago Seguros',
    explanationDescription: 'Opciones de pago 100% seguras:\n\n‚Ä¢ üí≥ WEBPAY: Tarjetas cr√©dito y d√©bito Transbank\n‚Ä¢ üì± FLOW: Pago con Flow (m√∫ltiples bancos)\n‚Ä¢ üõí MERCADOPAGO: Plataforma MercadoPago\n‚Ä¢ üè¶ TRANSFERENCIA: Transferencia bancaria directa\n\n‚Ä¢ Encriptaci√≥n SSL de datos\n‚Ä¢ Certificados de seguridad\n‚Ä¢ Sin almacenar informaci√≥n sensible\n‚Ä¢ Procesamiento instant√°neo y confiable'
  },
  {
    id: 'pago-summary-card',
    target: '.sticky.top-4, div:has(button[class*="bg-green"])',
    title: 'Resumen de Pago',
    description: 'Te muestro el resumen final con el total a pagar.',
    action: 'HAZ CLIC en el resumen de pago',
    position: 'left',
    explanationTitle: '‚úÖ Resumen Inteligente',
    explanationDescription: 'El resumen incluye:\n\n‚Ä¢ BOLETAS SELECCIONADAS: Cantidad y detalle\n‚Ä¢ DESGLOSE INDIVIDUAL: Cada boleta con su monto\n‚Ä¢ TOTAL CALCULADO: Suma autom√°tica actualizada\n‚Ä¢ T√âRMINOS Y CONDICIONES: Aceptaci√≥n obligatoria\n‚Ä¢ BOT√ìN PAGO SEGURO: Con escudo de protecci√≥n\n‚Ä¢ INFO SEGURIDAD: Garant√≠a de encriptaci√≥n\n\n‚Ä¢ Transparencia total en costos\n‚Ä¢ Sin cargos ocultos ni sorpresas'
  },
  {
    id: 'pago-security-info',
    target: '.bg-blue-50.border-blue-200, div:has(.text-blue-800)',
    title: 'Informaci√≥n de Seguridad',
    description: 'Te muestro la garant√≠a de seguridad en los pagos.',
    action: 'HAZ CLIC en la informaci√≥n de seguridad',
    position: 'top',
    explanationTitle: '‚úÖ Garant√≠a de Seguridad Total',
    explanationDescription: 'Protecci√≥n completa garantizada:\n\n‚Ä¢ üîí ENCRIPTACI√ìN SSL: Datos protegidos en tr√°nsito\n‚Ä¢ üõ°Ô∏è CERTIFICADOS: Validaci√≥n de seguridad\n‚Ä¢ üö´ SIN ALMACENAMIENTO: No guardamos datos bancarios\n‚Ä¢ ‚ö° PROCESAMIENTO SEGURO: Directo con proveedores\n‚Ä¢ üì± COMPATIBLE: Funciona en todos los dispositivos\n‚Ä¢ üîê CUMPLIMIENTO NORMATIVO: Est√°ndares internacionales\n\nTu informaci√≥n est√° 100% protegida.'
  },
  {
    id: 'chat',
    target: '#nav-chat',
    title: 'Haz clic en Soporte',
    description: 'Ahora veamos el chat de ayuda.',
    action: 'HAZ CLIC en "Soporte" resaltado',
    position: 'right',
    explanationTitle: '‚úÖ Genial! Accediste al Chat',
    explanationDescription: 'Vamos a ver c√≥mo funciona el sistema de soporte.'
  },
  // Chat sub-steps
  {
    id: 'chat-header-section',
    target: '.bg-white.border-b, div:has(.text-lg.font-semibold)',
    title: 'Header del Chat',
    description: 'Te muestro la informaci√≥n del chat y estado de conexi√≥n.',
    action: 'HAZ CLIC en el header del chat',
    position: 'bottom',
    explanationTitle: '‚úÖ Header Inteligente del Chat',
    explanationDescription: 'El header contiene informaci√≥n clave:\n\n‚Ä¢ ESTADO DEL CHAT: Activo/Cerrado\n‚Ä¢ ADMINISTRADOR ASIGNADO: Qui√©n te atiende\n‚Ä¢ MENSAJES NUEVOS: Contador de no le√≠dos\n‚Ä¢ ESTADO DE CONEXI√ìN: En l√≠nea/Desconectado (indicador)\n‚Ä¢ FECHA DE INICIO: Cu√°ndo comenz√≥ la conversaci√≥n\n\n‚Ä¢ Informaci√≥n en tiempo real\n‚Ä¢ Transparencia total del servicio'
  },
  {
    id: 'chat-messages-area',
    target: '.h-96.overflow-y-auto, div:has(.h-96.overflow-y-auto)',
    title: '√Årea de Mensajes',
    description: 'Te muestro donde aparecen todos los mensajes de la conversaci√≥n.',
    action: 'HAZ CLIC en el √°rea de mensajes',
    position: 'right',
    explanationTitle: '‚úÖ √Årea de Conversaci√≥n',
    explanationDescription: 'Funcionalidades del √°rea de mensajes:\n\n‚Ä¢ HISTORIAL COMPLETO: Todos los mensajes guardados\n‚Ä¢ MENSAJES PROPIOS: En azul a la derecha\n‚Ä¢ MENSAJES ADMIN: En gris a la izquierda\n‚Ä¢ INDICADORES DE ESTADO: ‚úì enviado, ‚úì‚úì le√≠do\n‚Ä¢ TIMESTAMPS: Hora de cada mensaje\n‚Ä¢ SCROLL AUTOM√ÅTICO: Se posiciona en el √∫ltimo mensaje\n‚Ä¢ INDICADOR ESCRIBIENDO: Puntos animados cuando escriben'
  },
  {
    id: 'chat-input-area',
    target: '.border-t.px-4.py-4, div:has(textarea[placeholder*="mensaje"])',
    title: '√Årea de Escritura',
    description: 'Te muestro donde puedes escribir tus mensajes.',
    action: 'HAZ CLIC en el √°rea de escritura',
    position: 'top',
    explanationTitle: '‚úÖ √Årea de Escritura Avanzada',
    explanationDescription: 'Funcionalidades de escritura:\n\n‚Ä¢ TEXTAREA EXPANDIBLE: Se adapta al contenido\n‚Ä¢ L√çMITE DE CARACTERES: 1000 caracteres m√°ximo\n‚Ä¢ CONTADOR VISIBLE: Muestra caracteres usados\n‚Ä¢ ATAJOS DE TECLADO: Enter para enviar, Shift+Enter para nueva l√≠nea\n‚Ä¢ INDICADOR ESCRIBIENDO: Notifica a los admins cuando escribes\n‚Ä¢ ENV√çO INTELIGENTE: Solo se activa con texto\n‚Ä¢ ESTADO LOADING: Muestra enviando...'
  },
  {
    id: 'chat-actions-section',
    target: 'button:has(.h-5.w-5), .bg-blue-600.text-white',
    title: 'Bot√≥n de Env√≠o',
    description: 'Te muestro el bot√≥n para enviar mensajes.',
    action: 'HAZ CLIC en el bot√≥n de env√≠o',
    position: 'left',
    explanationTitle: '‚úÖ Bot√≥n de Env√≠o Inteligente',
    explanationDescription: 'Caracter√≠sticas del bot√≥n de env√≠o:\n\n‚Ä¢ √çCONO SEND: Claro y reconocible ‚úàÔ∏è\n‚Ä¢ ESTADO DISABLED: Se desactiva sin texto\n‚Ä¢ ANIMACI√ìN LOADING: Spinner mientras env√≠a\n‚Ä¢ FEEDBACK VISUAL: Cambia color al hover\n‚Ä¢ PREVENCI√ìN SPAM: No permite env√≠o m√∫ltiple\n‚Ä¢ ACCESIBILIDAD: Funciona con Enter\n\nEnv√≠o r√°pido y seguro garantizado.'
  },
  {
    id: 'chat-help-section',
    target: '.px-4.py-2.bg-blue-50, div:has(.text-xs.text-blue-700)',
    title: 'Ayuda de Chat',
    description: 'Te muestro los tips de uso del chat.',
    action: 'HAZ CLIC en la ayuda del chat',
    position: 'top',
    explanationTitle: '‚úÖ Ayuda y Tips Integrados',
    explanationDescription: 'Tips √∫tiles del chat:\n\n‚Ä¢ üí° ENTER: Env√≠a mensaje directamente\n‚Ä¢ üí° SHIFT + ENTER: Salto de l√≠nea sin enviar\n‚Ä¢ üí° L√çMITE: M√°ximo 1000 caracteres por mensaje\n‚Ä¢ üí° TIEMPO REAL: Los mensajes llegan instant√°neamente\n‚Ä¢ üí° HISTORIAL: Se guarda toda la conversaci√≥n\n‚Ä¢ üí° NOTIFICACIONES: Te avisamos de respuestas\n\nUso √≥ptimo y eficiente del sistema.'
  },
  {
    id: 'dashboard',
    target: '#nav-dashboard',
    title: 'Vuelve al Dashboard',
    description: 'Regresemos al panel principal.',
    action: 'HAZ CLIC en "Dashboard" resaltado',
    position: 'right',
    explanationTitle: '‚úÖ Perfecto! Volviste al Dashboard',
    explanationDescription: 'Ahora vamos a ver las funcionalidades del panel principal.'
  },
  // Dashboard sub-steps
  {
    id: 'dashboard-welcome-cards',
    target: '#welcome-cards, div[id="welcome-cards"]',
    title: 'Tarjetas de Resumen Financiero',
    description: 'Te muestro las 3 tarjetas principales con tu estado financiero.',
    action: 'HAZ CLIC en las tarjetas de resumen financiero',
    position: 'top',
    explanationTitle: '‚úÖ Resumen Financiero Completo',
    explanationDescription: 'Las 3 tarjetas principales muestran:\n\n‚Ä¢ üí∞ SALDO ACTUAL: Cr√©dito disponible en verde\n‚Ä¢ ‚ö†Ô∏è DEUDA TOTAL: Monto pendiente en rojo\n‚Ä¢ üìä ESTADO GENERAL: Badge con estado de cuenta\n\n‚Ä¢ Colores sem√°foro para interpretaci√≥n r√°pida\n‚Ä¢ √çconos descriptivos (DollarSign, AlertCircle, CheckCircle)\n‚Ä¢ Actualizaci√≥n autom√°tica con cada pago\n‚Ä¢ Indicadores de criticidad por colores\n\nVisi√≥n financiera instant√°nea y clara.'
  },
  {
    id: 'dashboard-quick-actions',
    target: '.grid.grid-cols-1.md\\:grid-cols-4.gap-4:has(.h-20), div:has(button.h-20.flex.flex-col)',
    title: 'Botones de Acci√≥n R√°pida',
    description: 'Te muestro los 4 botones para acceso directo a funciones.',
    action: 'HAZ CLIC en los botones de acci√≥n r√°pida',
    position: 'bottom',
    explanationTitle: '‚úÖ Acciones R√°pidas Inteligentes',
    explanationDescription: 'Los 4 botones principales ofrecen:\n\n‚Ä¢ üìÑ VER MIS BOLETAS: Acceso directo a facturas\n‚Ä¢ üí≥ PAGAR DEUDA: Bot√≥n habilitado solo con deuda\n‚Ä¢ üìú HISTORIAL DE PAGOS: Registro de pagos anteriores\n‚Ä¢ üí¨ CHAT DE SOPORTE: Ayuda directa en vivo\n\n‚Ä¢ √çconos grandes (FileText, CreditCard, History, MessageCircle)\n‚Ä¢ Estados din√°micos (habilitado/deshabilitado)\n‚Ä¢ Navegaci√≥n directa a cada secci√≥n\n‚Ä¢ Altura fija de 20 (h-20) para uniformidad'
  },
  {
    id: 'dashboard-contact-info',
    target: '.grid.grid-cols-1.md\\:grid-cols-2.gap-6:has(.text-sm.text-gray-600), div:has(.text-sm.text-gray-600:contains("Email"))',
    title: 'Informaci√≥n Personal y de Cuenta',
    description: 'Te muestro las tarjetas con tu informaci√≥n personal y de cuenta.',
    action: 'HAZ CLIC en las tarjetas de informaci√≥n',
    position: 'right',
    explanationTitle: '‚úÖ Informaci√≥n Personal Completa',
    explanationDescription: 'Dos tarjetas informativas contienen:\n\n‚Ä¢ üìß INFORMACI√ìN DE CONTACTO:\n  - Email registrado\n  - Tel√©fono (si existe)\n  - Direcci√≥n (si existe)\n\n‚Ä¢ üÜî INFORMACI√ìN DE CUENTA:\n  - RUT identificador\n  - Fecha de ingreso al sistema\n  - Estado de cuenta (Activo/Inactivo)\n\n‚Ä¢ Datos de solo lectura\n‚Ä¢ Informaci√≥n siempre actualizada\n‚Ä¢ Base para edici√≥n en perfil'
  },
  {
    id: 'dashboard-debt-alert',
    target: '.mt-6.border-yellow-200.bg-yellow-50, div:has(.text-yellow-800:contains("Tienes deuda pendiente"))',
    title: 'Alerta de Deuda',
    description: 'Te muestro la alerta que aparece cuando tienes deuda pendiente.',
    action: 'HAZ CLIC en la alerta de deuda (si aparece)',
    position: 'top',
    explanationTitle: '‚úÖ Sistema de Alertas Inteligente',
    explanationDescription: 'La alerta de deuda incluye:\n\n‚Ä¢ ‚ö†Ô∏è √çCONO DE ALERTA: AlertCircle visual llamativo\n‚Ä¢ MONTO ESPEC√çFICO: Cantidad exacta que debes\n‚Ä¢ RECOMENDACI√ìN: Pagar pronto para evitar recargos\n‚Ä¢ BOT√ìN PAGAR AHORA: Acceso directo al pago\n‚Ä¢ COLORES AMARILLO: border-yellow-200 bg-yellow-50\n\n‚Ä¢ Solo aparece CON deuda pendiente (condicional)\n‚Ä¢ Se oculta autom√°ticamente al pagar\n‚Ä¢ Previene olvidos y recargos\n‚Ä¢ Call-to-action claro y directo'
  },
  {
    id: 'floating-button',
    target: 'body',
    title: 'Bot√≥n Flotante Inteligente',
    description: 'FUNCIONALIDAD ESPECIAL: Cuando hagas scroll hacia abajo, aparecer√° autom√°ticamente un bot√≥n flotante azul en la esquina superior izquierda para acceso r√°pido al men√∫.',
    action: 'Haz scroll hacia abajo para ver el bot√≥n flotante',
    position: 'top'
  },
  {
    id: 'complete',
    target: 'body',
    title: '¬°Tutorial Completado! üéâ',
    description: 'Has completado el recorrido completo por todas las funciones:\n\n‚úÖ Perfil con campos editables y auto-guardado\n‚úÖ Boletas con filtros, lista y descargas PDF\n‚úÖ Pagos seguros con m√∫ltiples m√©todos\n‚úÖ Chat de soporte en vivo\n‚úÖ Dashboard con resumen y acciones r√°pidas\n‚úÖ Bot√≥n flotante inteligente\n\n¬°Ya conoces todo el portal!',
    action: 'Haz clic en "Finalizar" para cerrar',
    position: 'top'
  }
];

interface SpotlightTutorialProps {
  isOpen: boolean;
  onClose: () => void;
  userName: string;
}

export default function SpotlightTutorial({ isOpen, onClose, userName }: SpotlightTutorialProps) {
  const [currentStep, setCurrentStep] = useState(0);
  const [isWaitingForClick, setIsWaitingForClick] = useState(false);
  const [showExplanation, setShowExplanation] = useState(false);
  const [targetRect, setTargetRect] = useState<DOMRect | null>(null);
  const [popupPosition, setPopupPosition] = useState({ x: 0, y: 0 });
  const [isCalculating, setIsCalculating] = useState(false);

  const getCurrentStep = () => TUTORIAL_STEPS[currentStep];
  const isLastStep = currentStep === TUTORIAL_STEPS.length - 1;

  // Handler functions
  const handleNext = useCallback(() => {
    if (showExplanation) {
      // Move to next step after explanation
      setShowExplanation(false);
      if (isLastStep) {
        onClose();
      } else {
        setCurrentStep(prev => prev + 1);
      }
    } else {
      // Regular next step
      if (isLastStep) {
        onClose();
      } else {
        setCurrentStep(prev => prev + 1);
        setIsWaitingForClick(false);
      }
    }
  }, [showExplanation, isLastStep, onClose]);

  const handleSkipStep = useCallback(() => {
    setShowExplanation(false);
    if (isLastStep) {
      onClose();
    } else {
      setCurrentStep(prev => prev + 1);
      setIsWaitingForClick(false);
    }
  }, [isLastStep, onClose]);

  const handleFinishTutorial = useCallback(() => {
    onClose();
  }, [onClose]);

  const handleClose = useCallback(() => {
    onClose();
  }, [onClose]);

  // Calculate spotlight and popup position
  const calculatePositions = useCallback(() => {
    if (isCalculating) return; // Prevent multiple calculations
    
    const step = getCurrentStep();
    if (!step.target || step.target === 'body') return;

    setIsCalculating(true);
    
    // Use setTimeout to ensure DOM is ready
    setTimeout(() => {
      // Try multiple selectors for better element detection
      const selectors = step.target.split(',').map(s => s.trim());
      let element: HTMLElement | null = null;
      
      for (const selector of selectors) {
        element = document.querySelector(selector) as HTMLElement;
        if (element) break;
      }
    
    // Fallback: try to find elements by common patterns based on current view
    if (!element) {
      // Detect current view by checking which elements exist
      const isInProfileView = document.querySelector('#rut-section') !== null;
      const isInBoletasView = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-4') !== null;
      const isInDashboardView = document.querySelector('#welcome-cards') !== null;
      
      if (step.id.includes('profile') && !isInProfileView) {
        // If asking for profile elements but not in profile view, skip or wait
        return;
      }
      
      if (step.id.includes('boletas') && !isInBoletasView) {
        // If asking for boletas elements but not in boletas view, skip or wait  
        return;
      }
      
      if (step.id.includes('dashboard') && !isInDashboardView) {
        // If asking for dashboard elements but not in dashboard view, skip or wait
        return;
      }
      
      // Try fallback selectors only if in correct view
      const candidates = [
        // Profile elements
        '#rut-section',
        'div[id="rut-section"]',
        '#edit-profile-btn', 
        'button[id="edit-profile-btn"]',
        '#telefono-field',
        'div[id="telefono-field"]',
        '#direccion-field',
        'div[id="direccion-field"]',
        '.bg-green-50.rounded-lg.border-l-4.border-green-500',
        // Dashboard elements
        '#welcome-cards',
        'div[id="welcome-cards"]',
        '.grid.grid-cols-1.md\\:grid-cols-4.gap-4',
        'button.h-20.flex.flex-col',
        // Boletas elements
        '.grid.grid-cols-1.md\\:grid-cols-4.gap-6.mb-8',
        'input[placeholder*="Buscar por n√∫mero de boleta"]',
        '.flex.gap-2:has(button)',
        '.space-y-4:has(.hover\\:shadow-md)',
        // Chat elements
        '.bg-white.border-b',
        '.h-96.overflow-y-auto',
        'textarea[placeholder*="mensaje"]',
        '.bg-blue-600.text-white',
        // Pago elements  
        '.lg\\:col-span-2',
        'input[type="radio"]',
        '.sticky.top-4'
      ];
      for (const candidate of candidates) {
        const foundElement = document.querySelector(candidate) as HTMLElement;
        if (foundElement) {
          element = foundElement;
          break;
        }
      }
    }
    if (!element && step.id.includes('profile') && !step.id.includes('profile-')) {
      element = document.querySelector('[data-profile], .profile, .perfil') as HTMLElement;
    }
    if (!element && step.id.includes('boletas')) {
      element = document.querySelector('[data-boletas], .boletas, .bills') as HTMLElement;
    }
    if (!element && step.id.includes('pago')) {
      element = document.querySelector('[data-pago], .payment, .pago') as HTMLElement;
    }
    if (!element && step.id.includes('chat')) {
      element = document.querySelector('[data-chat], .chat, .soporte') as HTMLElement;
    }

      if (!element) {
        setIsCalculating(false);
        return;
      }

      const rect = element.getBoundingClientRect();
      setTargetRect(rect);

      // Calculate popup position based on step.position
      let x = rect.left;
      let y = rect.top;

      switch (step.position) {
        case 'right':
          x = rect.right + 20;
          y = rect.top;
          break;
        case 'left':
          x = rect.left - 350;
          y = rect.top;
          break;
        case 'bottom':
          x = rect.left;
          y = rect.bottom + 20;
          break;
        case 'top':
          x = rect.left;
          y = rect.top - 200;
          break;
      }

      // Keep popup within viewport
      const popupWidth = 350;
      const popupHeight = 200;
      
      if (x + popupWidth > window.innerWidth) {
        x = window.innerWidth - popupWidth - 20;
      }
      if (x < 20) x = 20;
      if (y + popupHeight > window.innerHeight) {
        y = window.innerHeight - popupHeight - 20;
      }
      if (y < 20) y = 20;

      setPopupPosition({ x, y });
      setIsCalculating(false);
    }, 50); // Small delay to ensure DOM stability
  }, [currentStep, isCalculating]);


  // Setup spotlight effect
  useEffect(() => {
    if (!isOpen) return;

    const step = getCurrentStep();
    
    // Handle body/welcome steps (no click required)
    if (step.target === 'body' || !step.target) {
      setIsWaitingForClick(false);
      setShowExplanation(false);
      calculatePositions();
      return;
    }

    // If showing explanation, don't set up click listeners
    if (showExplanation) {
      calculatePositions();
      return;
    }

    // Calculate positions first
    calculatePositions();

    // Try multiple selectors for better element detection
    const selectors = step.target.split(',').map(s => s.trim());
    let element: HTMLElement | null = null;
    
    for (const selector of selectors) {
      element = document.querySelector(selector) as HTMLElement;
      if (element) break;
    }
    
    // Fallback: try to find elements by common patterns based on current view
    if (!element) {
      // Detect current view by checking which elements exist
      const isInProfileView = document.querySelector('#rut-section') !== null;
      const isInBoletasView = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-4') !== null;
      const isInDashboardView = document.querySelector('#welcome-cards') !== null;
      
      if (step.id.includes('profile') && !isInProfileView) {
        // If asking for profile elements but not in profile view, auto-advance or wait
        console.warn(`Tutorial: Profile step ${step.id} but not in profile view`);
        return;
      }
      
      if (step.id.includes('boletas') && !isInBoletasView) {
        console.warn(`Tutorial: Boletas step ${step.id} but not in boletas view`);
        return;
      }
      
      if (step.id.includes('dashboard') && !isInDashboardView) {
        console.warn(`Tutorial: Dashboard step ${step.id} but not in dashboard view`);
        return;
      }
      
      const candidates = [
        // Profile elements
        '#rut-section',
        'div[id="rut-section"]',
        '#edit-profile-btn', 
        'button[id="edit-profile-btn"]',
        '#telefono-field',
        'div[id="telefono-field"]',
        '#direccion-field',
        'div[id="direccion-field"]',
        '.bg-green-50.rounded-lg.border-l-4.border-green-500',
        // Dashboard elements
        '#welcome-cards',
        'div[id="welcome-cards"]',
        '.grid.grid-cols-1.md\\:grid-cols-4.gap-4',
        'button.h-20.flex.flex-col',
        // Boletas elements
        '.grid.grid-cols-1.md\\:grid-cols-4.gap-6.mb-8',
        'input[placeholder*="Buscar por n√∫mero de boleta"]',
        '.flex.gap-2:has(button)',
        '.space-y-4:has(.hover\\:shadow-md)',
        // Chat elements
        '.bg-white.border-b',
        '.h-96.overflow-y-auto',
        'textarea[placeholder*="mensaje"]',
        '.bg-blue-600.text-white',
        // Pago elements  
        '.lg\\:col-span-2',
        'input[type="radio"]',
        '.sticky.top-4'
      ];
      for (const candidate of candidates) {
        const foundElement = document.querySelector(candidate) as HTMLElement;
        if (foundElement) {
          element = foundElement;
          break;
        }
      }
    }
    if (!element && step.id.includes('profile') && !step.id.includes('profile-')) {
      element = document.querySelector('[data-profile], .profile, .perfil, input[name*="nombre"], .user-info') as HTMLElement;
    }
    if (!element && step.id.includes('boletas')) {
      element = document.querySelector('[data-boletas], .boletas, .bills, .facturas') as HTMLElement;
    }
    if (!element && step.id.includes('pago')) {
      element = document.querySelector('[data-pago], .payment, .pago, .pay') as HTMLElement;
    }
    if (!element && step.id.includes('chat')) {
      element = document.querySelector('[data-chat], .chat, .soporte, .support') as HTMLElement;
    }
    
    if (!element) {
      console.warn(`Tutorial: Element not found for step: ${step.id}, target: ${step.target}`);
      // Don't auto-skip, just show error message instead
      setIsWaitingForClick(false);
      return;
    }

    // Set up click detection
    setIsWaitingForClick(true);
    
    // Add click listener with high priority
    const clickHandler = (e: Event) => {
      console.log('Click detected on tutorial element:', element);
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      setIsWaitingForClick(false);
      
      // Show explanation after click
      if (step.explanationTitle && step.explanationDescription) {
        setShowExplanation(true);
      } else {
        // If no explanation, move to next step
        setTimeout(() => {
          if (currentStep < TUTORIAL_STEPS.length - 1) {
            setCurrentStep(prev => prev + 1);
          }
        }, 500);
      }
      
      return false;
    };

    element.addEventListener('click', clickHandler, true);
    element.addEventListener('mousedown', clickHandler, true);

    return () => {
      element.removeEventListener('click', clickHandler, true);
      element.removeEventListener('mousedown', clickHandler, true);
    };
  }, [isOpen, currentStep, showExplanation, calculatePositions]);

  // Update positions on scroll/resize with throttling
  useEffect(() => {
    if (!isOpen) return;

    let ticking = false;
    const updatePositions = () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          calculatePositions();
          ticking = false;
        });
        ticking = true;
      }
    };
    
    window.addEventListener('scroll', updatePositions, { passive: true });
    window.addEventListener('resize', updatePositions, { passive: true });
    
    return () => {
      window.removeEventListener('scroll', updatePositions);
      window.removeEventListener('resize', updatePositions);
    };
  }, [isOpen, calculatePositions]);



  if (!isOpen) return null;

  const step = getCurrentStep();
  const hasSpotlight = step.target !== 'body' && targetRect && !showExplanation;

  return (
    <>
      {/* Dark Overlay with Spotlight */}
      <div className="fixed inset-0 z-[9999] pointer-events-none">
        {/* Four overlay sections to create spotlight effect */}
        {hasSpotlight ? (
          <>
            {/* Top section */}
            <div
              className="absolute bg-black bg-opacity-30 cursor-not-allowed"
              style={{
                left: 0,
                top: 0,
                width: '100%',
                height: targetRect.top - 8,
                pointerEvents: 'auto'
              }}
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
              }}
            />
            
            {/* Bottom section */}
            <div
              className="absolute bg-black bg-opacity-30 cursor-not-allowed"
              style={{
                left: 0,
                top: targetRect.bottom + 8,
                width: '100%',
                height: `calc(100% - ${targetRect.bottom + 8}px)`,
                pointerEvents: 'auto'
              }}
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
              }}
            />
            
            {/* Left section */}
            <div
              className="absolute bg-black bg-opacity-30 cursor-not-allowed"
              style={{
                left: 0,
                top: targetRect.top - 8,
                width: targetRect.left - 8,
                height: targetRect.height + 16,
                pointerEvents: 'auto'
              }}
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
              }}
            />
            
            {/* Right section */}
            <div
              className="absolute bg-black bg-opacity-30 cursor-not-allowed"
              style={{
                left: targetRect.right + 8,
                top: targetRect.top - 8,
                width: `calc(100% - ${targetRect.right + 8}px)`,
                height: targetRect.height + 16,
                pointerEvents: 'auto'
              }}
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
              }}
            />
          </>
        ) : (
          /* Full overlay for non-spotlight steps */
          <div className="absolute inset-0 bg-black bg-opacity-35 pointer-events-auto" />
        )}

        {/* Highlighted Element Border */}
        {hasSpotlight && (
          <div
            className="absolute border-2 border-blue-500 rounded-lg shadow-lg animate-pulse pointer-events-none transition-all duration-300 ease-in-out"
            style={{
              left: targetRect.left - 4,
              top: targetRect.top - 4,
              width: targetRect.width + 8,
              height: targetRect.height + 8,
              boxShadow: '0 0 0 4px rgba(59, 130, 246, 0.3), 0 0 20px rgba(59, 130, 246, 0.5)'
            }}
          />
        )}
      </div>

      {/* Tutorial Popup */}
      <div
        className="fixed z-[10000] bg-white rounded-xl shadow-2xl w-80"
        style={{
          left: hasSpotlight ? popupPosition.x : '50%',
          top: hasSpotlight ? popupPosition.y : '50%',
          transform: hasSpotlight ? 'none' : 'translate(-50%, -50%)'
        }}
      >
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b">
          <div className="flex items-center gap-3">
            <div className="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
              <Target className="w-4 h-4 text-white" />
            </div>
            <div>
              <h2 className="font-semibold text-sm">Tutorial Interactivo</h2>
              <p className="text-xs text-gray-500">Paso {currentStep + 1} de {TUTORIAL_STEPS.length}</p>
            </div>
          </div>
          <button
            onClick={handleClose}
            className="p-1 hover:bg-gray-100 rounded-full transition-colors"
          >
            <X className="w-4 h-4" />
          </button>
        </div>

        {/* Progress Bar */}
        <div className="px-4 pt-3">
          <div className="w-full bg-gray-200 rounded-full h-1.5">
            <div 
              className="bg-blue-600 h-1.5 rounded-full transition-all duration-500"
              style={{ width: `${((currentStep + 1) / TUTORIAL_STEPS.length) * 100}%` }}
            />
          </div>
        </div>

        {/* Content */}
        <div className="p-4">
          <div className="mb-4">
            {step.id === 'complete' ? (
              <div className="text-4xl mb-3 text-center">üéâ</div>
            ) : isWaitingForClick ? (
              <div className="text-4xl mb-3 text-center animate-bounce">üëÜ</div>
            ) : (
              <div className="text-4xl mb-3 text-center">üéØ</div>
            )}
            
            <h3 className="text-lg font-bold mb-2">
              {showExplanation && step.explanationTitle ? step.explanationTitle : step.title}
            </h3>
            
            <p className="text-sm text-gray-600 leading-relaxed mb-3">
              {showExplanation && step.explanationDescription ? step.explanationDescription : step.description}
            </p>

            {isWaitingForClick && !showExplanation ? (
              <div className="space-y-3">
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                  <div className="flex items-center gap-2 text-blue-700 text-sm font-medium">
                    <div className="animate-bounce">üëÜ</div>
                    <span>{step.action}</span>
                  </div>
                </div>
                
                {/* Manual navigation buttons when waiting for click */}
                <div className="flex gap-2">
                  <button
                    onClick={handleSkipStep}
                    className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-1"
                  >
                    Saltar
                    <ArrowRight className="w-3 h-3" />
                  </button>
                  <button
                    onClick={handleFinishTutorial}
                    className="flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-1"
                  >
                    <X className="w-3 h-3" />
                    Finalizar
                  </button>
                </div>
              </div>
            ) : showExplanation ? (
              <div className="space-y-3">
                <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                  <div className="flex items-center gap-2 text-green-700 text-sm font-medium">
                    <CheckCircle className="w-4 h-4" />
                    <span>¬°Clic detectado! Ahora entiendes para qu√© sirve esta funci√≥n</span>
                  </div>
                </div>
                
                <button
                  onClick={handleNext}
                  className="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
                >
                  {isLastStep ? 'Finalizar Tutorial' : 'Continuar al Siguiente'}
                  <ArrowRight className="w-4 h-4" />
                </button>
                
                <button
                  onClick={handleFinishTutorial}
                  className="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2"
                >
                  <X className="w-4 h-4" />
                  Finalizar Tutorial Ahora
                </button>
              </div>
            ) : (
              <div className="space-y-3">
                <button
                  onClick={handleNext}
                  className="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
                >
                  {isLastStep ? (
                    <>
                      <CheckCircle className="w-4 h-4" />
                      Finalizar Tutorial
                    </>
                  ) : (
                    <>
                      Continuar
                      <ArrowRight className="w-4 h-4" />
                    </>
                  )}
                </button>
                
                {/* Manual navigation when not waiting for click */}
                {!isLastStep && (
                  <button
                    onClick={handleFinishTutorial}
                    className="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2"
                  >
                    <X className="w-4 h-4" />
                    Finalizar Tutorial
                  </button>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    </>
  );
}

// Hook para usar el tutorial spotlight
export function useSpotlightTutorial() {
  const [showTutorial, setShowTutorial] = useState(false);

  useEffect(() => {
    const hasCompletedTutorial = localStorage.getItem('spotlight-tutorial-completed');
    if (!hasCompletedTutorial) {
      const timer = setTimeout(() => {
        setShowTutorial(true);
      }, 2000);
      return () => clearTimeout(timer);
    }
  }, []);

  const startTutorial = () => setShowTutorial(true);
  
  const hideTutorial = () => {
    setShowTutorial(false);
    localStorage.setItem('spotlight-tutorial-completed', 'true');
  };

  const resetTutorial = () => {
    localStorage.removeItem('spotlight-tutorial-completed');
    setShowTutorial(true);
  };

  return {
    showTutorial,
    startTutorial,
    hideTutorial,
    resetTutorial
  };
}